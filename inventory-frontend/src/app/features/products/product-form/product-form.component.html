<section class="product-form" aria-labelledby="product-title">
  <div class="form-container">
    <header class="form-header">
      <h1 id="product-title">{{ isEdit ? 'Edit Product' : 'Create New Product' }}</h1>
    </header>

    <form [formGroup]="productForm" (ngSubmit)="onSubmit()" class="form" novalidate>
      <div class="form-group" [class.has-error]="isFieldInvalid('name')">
        <label for="name">Product Name <span class="req">*</span></label>

        <div class="input-wrapper">
          <svg class="input-icon" width="18" height="18" viewBox="0 0 24 24" aria-hidden="true">
            <path d="M12 12c2.7 0 4.8-2.1 4.8-4.8S14.7 2.4 12 2.4 7.2 4.5 7.2 7.2 9.3 12 12 12zm0 2.4c-3.2 0-9.6 1.6-9.6 4.8V22h19.2v-2.8c0-3.2-6.4-4.8-9.6-4.8z" fill="currentColor"/>
          </svg>

          <input
            type="text"
            id="name"
            formControlName="name"
            class="form-control"
            [class.error]="isFieldInvalid('name')"
            placeholder="Enter product name"
            autocomplete="off"
            [attr.aria-invalid]="isFieldInvalid('name')"
            [attr.aria-describedby]="isFieldInvalid('name') ? 'name-error' : 'name-help'">

          <span class="char-counter" *ngIf="productForm.get('name') as ctrl">
            {{ (ctrl.value?.length || 0) }} / 60
          </span>
        </div>

        <div id="name-error" class="error-message" *ngIf="isFieldInvalid('name')" aria-live="polite">
          <span *ngIf="productForm.get('name')?.errors?.['required']">Name is required</span>
          <span *ngIf="productForm.get('name')?.errors?.['minlength']">Name must be at least 3 characters</span>
        </div>
      </div>

      <div class="form-group" [class.has-error]="isFieldInvalid('description')">
        <label for="description">Description <span class="req">*</span></label>

        <div class="input-wrapper textarea">
          <textarea
            id="description"
            formControlName="description"
            class="form-control"
            [class.error]="isFieldInvalid('description')"
            placeholder="Enter product description"
            rows="4"
            [attr.aria-invalid]="isFieldInvalid('description')"
            [attr.aria-describedby]="isFieldInvalid('description') ? 'desc-error' : 'desc-help'"></textarea>

          <span class="char-counter" *ngIf="productForm.get('description') as ctrlDesc">
            {{ (ctrlDesc.value?.length || 0) }} / 240
          </span>
        </div>

        <div id="desc-error" class="error-message" *ngIf="isFieldInvalid('description')" aria-live="polite">
          <span *ngIf="productForm.get('description')?.errors?.['required']">Description is required</span>
          <span *ngIf="productForm.get('description')?.errors?.['minlength']">Description must be at least 10 characters</span>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group" [class.has-error]="isFieldInvalid('stockQuantity')">
          <label for="stockQuantity">Stock Quantity <span class="req">*</span></label>

          <div class="input-wrapper">
            <svg class="input-icon" width="18" height="18" viewBox="0 0 24 24" aria-hidden="true">
              <path d="M3 7h18v2H3V7zm0 4h18v2H3v-2zm0 4h18v2H3v-2z" fill="currentColor"/>
            </svg>

            <input
              type="number"
              id="stockQuantity"
              formControlName="stockQuantity"
              class="form-control"
              [class.error]="isFieldInvalid('stockQuantity')"
              min="0"
              inputmode="numeric">

          </div>

          <div class="error-message" *ngIf="isFieldInvalid('stockQuantity')" aria-live="polite">
            <span *ngIf="productForm.get('stockQuantity')?.errors?.['required']">Stock quantity is required</span>
            <span *ngIf="productForm.get('stockQuantity')?.errors?.['min']">Stock cannot be negative</span>
          </div>
        </div>

        <div class="form-group" [class.has-error]="isFieldInvalid('price')">
          <label for="price">Price <span class="req">*</span></label>

          <div class="input-wrapper affix-left">
            <span class="prefix" aria-hidden="true">$</span>
            <input
              type="number"
              id="price"
              formControlName="price"
              class="form-control"
              [class.error]="isFieldInvalid('price')"
              min="0.01"
              step="0.01"
              inputmode="decimal"
              placeholder="0.00">
          </div>

          <div class="error-message" *ngIf="isFieldInvalid('price')" aria-live="polite">
            <span *ngIf="productForm.get('price')?.errors?.['required']">Price is required</span>
            <span *ngIf="productForm.get('price')?.errors?.['min']">Price must be greater than 0</span>
          </div>
        </div>
      </div>

      <div class="form-group" [class.has-error]="isFieldInvalid('pictureUrl')">
        <label for="pictureUrl">Image URL <span class="req">*</span></label>

        <div class="input-wrapper">
          <svg class="input-icon" width="18" height="18" viewBox="0 0 24 24" aria-hidden="true">
            <path d="M21 5H3a2 2 0 00-2 2v10a2 2 0 002 2h18a2 2 0 002-2V7a2 2 0 00-2-2zm-1 10l-4.5-6-3.5 4.5L9 11l-5 6h16z" fill="currentColor"/>
          </svg>

          <input
            type="url"
            id="pictureUrl"
            formControlName="pictureUrl"
            class="form-control"
            [class.error]="isFieldInvalid('pictureUrl')"
            placeholder="https://example.com/image.jpg"
            inputmode="url">
        </div>

        <div class="error-message" *ngIf="isFieldInvalid('pictureUrl')">Image URL is required</div>

        <div *ngIf="productForm.get('pictureUrl')?.value" class="image-preview">
          <div class="image-frame">
            <img [src]="productForm.get('pictureUrl')?.value" alt="Preview" onerror="this.style.display='none'">
          </div>
          <p class="image-hint">Preview (auto-fit)</p>
        </div>
      </div>

      <div class="form-group" [class.has-error]="isFieldInvalid('categoryId')">
        <label for="categoryId">Category <span class="req">*</span></label>

        <div class="input-wrapper">
          <select
            id="categoryId"
            formControlName="categoryId"
            class="form-control"
            [class.error]="isFieldInvalid('categoryId')"
            [attr.aria-invalid]="isFieldInvalid('categoryId')">
            <option value="">Select a category</option>
            <option *ngFor="let category of categories" [value]="category.id">
              {{ category.name }}
            </option>
          </select>
        </div>

        <div class="error-message" *ngIf="isFieldInvalid('categoryId')">Category is required</div>
      </div>

      <div class="form-actions">
        <a routerLink="/products" class="btn btn-secondary" role="button">Cancel</a>
        <button type="submit" class="btn btn-primary" [disabled]="productForm.invalid || isLoading">
          <span class="btn-content" *ngIf="!isLoading">
            {{ isEdit ? 'Update Product' : 'Create Product' }}
          </span>
          <span class="btn-loading" *ngIf="isLoading">
            <span class="spinner" aria-hidden="true"></span>
            Saving...
          </span>
        </button>
      </div>
    </form>
  </div>
</section>
